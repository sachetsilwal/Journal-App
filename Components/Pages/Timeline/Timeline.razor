@page "/timeline"
@inject IJournalService JournalService

<MudPaper Class="pa-6 glass fade-in">
    <MudText Typo="Typo.h4">ðŸ•’ Journal Timeline</MudText>
    <MudText Typo="Typo.subtitle2" Class="mb-4">
        Search, filter, and browse your past entries.
    </MudText>

    <!-- Filters -->
    <MudGrid Spacing="2" Class="mb-4">
        <MudItem xs="12" md="4">
            <MudTextField @bind-Value="_query"
                          Placeholder="Search title or content..."
                          Variant="Variant.Outlined"
                          Dense="true"
                          Immediate="true"
                          OnBlur="Reload" />
        </MudItem>

        <MudItem xs="6" md="2">
            <MudDatePicker @bind-Date="_from"
                           Label="From"
                           Dense="true" />
        </MudItem>

        <MudItem xs="6" md="2">
            <MudDatePicker @bind-Date="_to"
                           Label="To"
                           Dense="true" />
        </MudItem>

        <MudItem xs="6" md="2">
            <MudSelect T="Mood?" Label="Mood"
                       Dense="true"
                       Clearable="true"
                       @bind-Value="_mood">
                @foreach (var m in Enum.GetValues<Mood>())
                {
                    <MudSelectItem Value="@( (Mood?)m )">@m</MudSelectItem>
                }
            </MudSelect>
        </MudItem>

        <MudItem xs="6" md="2">
            <MudTextField @bind-Value="_tag"
                          Label="Tag"
                          Dense="true" />
        </MudItem>
    </MudGrid>

    <!-- Timeline -->
    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" />
    }
    else if (_items.Count == 0)
    {
        <MudAlert Severity="Severity.Info">
            No entries found for selected filters.
        </MudAlert>
    }
    else
    {
        <div class="timeline">
            @foreach (var e in _items)
            {
                <MudPaper Class="pa-4 mb-3 timeline-item">
                    <MudText Typo="Typo.subtitle1">
                        @e.EntryDate.ToString("yyyy-MM-dd") â€” @e.Title
                    </MudText>

                    <MudText Typo="Typo.caption">
                        Primary: @e.PrimaryMood
                        @if (e.SecondaryMood1 != null) { <span> â€¢ @e.SecondaryMood1</span> }
                        @if (e.SecondaryMood2 != null) { <span> â€¢ @e.SecondaryMood2</span> }
                    </MudText>

                    <MudText Typo="Typo.body2" Class="mt-2">
                        @(e.ContentMarkdown.Length > 180
                            ? e.ContentMarkdown[..180] + "..."
                            : e.ContentMarkdown)
                    </MudText>

                    @if (!string.IsNullOrWhiteSpace(e.TagsCsv))
                    {
                        <MudChipSet T="Mood" Class="mt-2">
                            <MudChip T="Mood" Value="@e.PrimaryMood" Variant="Variant.Filled" Size="Size.Small">
                                @e.PrimaryMood
                            </MudChip>

                            @if (e.SecondaryMood1 is Mood sm1)
                            {
                                <MudChip T="Mood" Value="@sm1" Variant="Variant.Outlined" Size="Size.Small">@sm1</MudChip>
                            }

                            @if (e.SecondaryMood2 is Mood sm2)
                            {
                                <MudChip T="Mood" Value="@sm2" Variant="Variant.Outlined" Size="Size.Small">@sm2</MudChip>
                            }
                        </MudChipSet>

                    }
                </MudPaper>
            }
        </div>

        <MudPagination Page="@_page"
                       PageSize="@_pageSize"
                       Count="@_total"
                       OnPageChanged="OnPageChanged"
                       Class="mt-4" />
    }
</MudPaper>

<style>
.glass { border-radius:16px; backdrop-filter: blur(10px); }
.fade-in { animation: fadeUp .45s ease-out; }
@@keyframes fadeUp { from{opacity:0; transform:translateY(14px);} to{opacity:1; transform:translateY(0);} }

.timeline-item {
    opacity:0;
    animation: stagger .45s ease forwards;
    transform: translateY(10px);
}
.timeline-item:nth-child(1){animation-delay:.05s;}
.timeline-item:nth-child(2){animation-delay:.10s;}
.timeline-item:nth-child(3){animation-delay:.15s;}
.timeline-item:nth-child(4){animation-delay:.20s;}
.timeline-item:nth-child(5){animation-delay:.25s;}

@@keyframes stagger {
    to { opacity:1; transform:translateY(0); }
}
</style>

@code {
    private string? _query;
    private DateTime? _from;
    private DateTime? _to;
    private Mood? _mood;
    private string? _tag;

    private int _page = 1;
    private int _pageSize = 5;
    private int _total;

    private bool _loading = true;
    private List<JournalEntry> _items = new();

    protected override async Task OnInitializedAsync()
    {
        await Reload();
    }

    private async Task Reload()
    {
        _loading = true;

        var result = await JournalService.SearchAsync(
            _query,
            _from.HasValue ? DateOnly.FromDateTime(_from.Value) : null,
            _to.HasValue ? DateOnly.FromDateTime(_to.Value) : null,
            _mood,
            _tag,
            _page,
            _pageSize);

        _items = result.Items.ToList();
        _total = result.TotalCount;
        _loading = false;
    }

    private async Task OnPageChanged(int page)
    {
        _page = page;
        await Reload();
    }
}
